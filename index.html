<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HoÅŸgÃ¼nler v8.6 - Profesyonel Denetim Sistemi</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --warning: #f39c12; --info: #3498db; --bg: #f4f7f6; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; }
        
        nav { background: var(--primary); color: white; padding: 12px 8px; display: flex; gap: 8px; position: sticky; top: 0; z-index: 1000; overflow-x: auto; }
        nav button { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px; cursor: pointer; border-radius: 8px; font-weight: 600; flex-shrink: 0; }
        .active-nav { background: var(--accent) !important; }

        .container { padding: 12px; max-width: 1400px; margin: auto; }
        .page { display: none; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-height: 85vh; }
        .active-page { display: block !important; }

        /* LOG SÄ°STEMÄ° CSS */
        .log-filter-bar { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .log-entry { border-radius: 10px; margin-bottom: 15px; border-left: 6px solid #ccc; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Renk KodlarÄ± */
        .log-type-yeni { border-left-color: var(--info); }
        .log-type-guncelleme { border-left-color: var(--warning); }
        .log-type-odeme { border-left-color: var(--accent); }
        .log-type-eksik { border-left-color: var(--danger); }

        .log-header { background: #f8fafc; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .log-user { font-weight: bold; font-size: 12px; color: var(--primary); }
        .log-date { font-size: 11px; color: #777; }
        .log-body { padding: 15px; }
        .log-title { font-weight: 800; font-size: 14px; margin-bottom: 8px; display: block; }
        .log-detail-box { 
            background: #2d3436; color: #dfe6e9; padding: 12px; border-radius: 6px; 
            font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; 
            white-space: pre-wrap; word-break: break-all; margin: 0;
        }
        .diff-old { color: #ff7675; text-decoration: line-through; margin-right: 5px; }
        .diff-new { color: #55efc4; font-weight: bold; }

        /* Ortak stiller */
        .admin-only { display: none !important; } 
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .btn-save { width: 100%; background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-small { padding: 6px 10px; border-radius: 6px; border: none; font-size: 11px; font-weight: bold; color: white; cursor: pointer; }
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .item-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; inset:0; background:var(--primary); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px;">
    <h2>HoÅŸgÃ¼nler v8.6</h2>
    <div style="width:100%; max-width:350px; background:white; padding:25px; border-radius:15px; color:black;">
        <input type="text" id="loginUser" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="loginPass" placeholder="Åifre">
        <button onclick="login()" class="btn-save">GÄ°RÄ°Å</button>
    </div>
</div>

<nav id="navbar" style="display:none;">
    <button onclick="showPage('inventory')" class="nav-btn active-nav" id="btn-inventory">ğŸ“¦ ÃœrÃ¼nler</button>
    <button onclick="showPage('missing-list')" class="nav-btn" id="btn-missing-list">ğŸ“‹ Eksikler</button>
    <button onclick="showPage('suppliers')" class="nav-btn admin-only" id="btn-suppliers">ğŸšš ToptancÄ±</button>
    <button onclick="showPage('add-product')" class="nav-btn admin-only" id="btn-add-product">âš™ï¸ KayÄ±t</button>
    <button onclick="showPage('logs')" class="nav-btn admin-only" id="btn-logs">ğŸ•’ Loglar</button>
    <button onclick="logout()" style="background:var(--danger); margin-left:auto;">âŒ</button>
</nav>

<div class="container">
    <section id="inventory" class="page active-page">
        <input type="text" id="mainSearch" placeholder="ÃœrÃ¼n ara..." onkeyup="searchInventory()">
        <div id="inv_tableView" class="table-responsive">
            <table>
                <thead><tr><th>ÃœrÃ¼n</th><th class="admin-only">AlÄ±ÅŸ</th><th>Toptan</th><th>Per.</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="invBody"></tbody>
            </table>
        </div>
    </section>

    <section id="suppliers" class="page">
        <input type="text" id="supSearch" placeholder="ToptancÄ± ara..." onkeyup="renderSuppliers()">
        <div class="grid-container" id="supGridBody"></div>
    </section>

    <section id="add-product" class="page">
        <h2 id="formTitle">âš™ï¸ Yeni ÃœrÃ¼n KaydÄ±</h2>
        <div id="editModeInfo" style="display:none; background:#fff3cd; color:#856404; padding:10px; border-radius:8px; margin-bottom:10px; font-size:13px; border:1px solid #ffeeba;">
            âš ï¸ DÃ¼zenleme modundasÄ±nÄ±z. DeÄŸiÅŸiklikler kaydedilince loglanacaktÄ±r.
        </div>
        <input type="hidden" id="p_id">
        <input type="text" id="p_name" placeholder="ÃœrÃ¼n AdÄ±">
        <select id="p_supplier_select"></select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="number" id="p_buy" placeholder="AlÄ±ÅŸ">
            <input type="number" id="p_sellW" placeholder="Toptan">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="number" id="p_sellR" placeholder="Perakende">
            <input type="text" id="p_info" placeholder="Raf / Not">
        </div>
        <button onclick="saveProduct()" class="btn-save">ğŸ’¾ KAYDET</button>
        <button id="resetBtn" onclick="resetProductForm()" style="width:100%; background:#6c757d; color:white; padding:12px; border:none; border-radius:8px; margin-top:10px; display:none;">âŒ VAZGEÃ‡ / TEMÄ°ZLE</button>
    </section>

    <section id="missing-list" class="page">
        <select id="missingFilter" onchange="renderMissingList()"><option value="">TÃ¼m ToptancÄ±lar</option></select>
        <div class="table-responsive">
            <table><thead><tr><th>ÃœrÃ¼n</th><th>Miktar</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="missingBody"></tbody></table>
        </div>
    </section>

    <section id="logs" class="page">
        <div class="log-filter-bar">
            <input type="text" id="logSearch" placeholder="Loglarda ara (ÃœrÃ¼n, KullanÄ±cÄ±...)" onkeyup="renderLogs()">
            <select id="logTypeFilter" onchange="renderLogs()">
                <option value="">TÃ¼m Ä°ÅŸlemler</option>
                <option value="yeni">âœ¨ Yeni KayÄ±tlar</option>
                <option value="guncelleme">âœï¸ GÃ¼ncellemeler</option>
                <option value="odeme">ğŸ’° ToptancÄ± Ä°ÅŸlemleri</option>
                <option value="eksik">ğŸ“‹ Eksik Ä°ÅŸlemleri</option>
            </select>
        </div>
        <div id="logContent"></div>
    </section>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD3mtB4r5-nr-lclE7Qmqr51a0Tzmkib-A", authDomain: "hosgunler-2e576.firebaseapp.com", projectId: "hosgunler-2e576", storageBucket: "hosgunler-2e576.firebasestorage.app", messagingSenderId: "890789620690", appId: "1:890789620690:web:926f3952e4a6ff8050360b" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), patronEmail = "asim@hosgunler.com";
    const formatTRY = (val) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val || 0);

    let allProducts = [], allSuppliers = [], allMissing = [], allLogs = [];

    function login() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value;
        const email = u.includes('@') ? u : u + "@hosgunler.com";
        auth.signInWithEmailAndPassword(email, p).catch(e => alert("Hata: " + e.message));
    }

    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('navbar').style.display = 'flex';
            if(user.email === patronEmail) {
                const s = document.createElement('style');
                s.innerHTML = '.admin-only { display: inline-block !important; } td.admin-only, th.admin-only { display: table-cell !important; }';
                document.head.appendChild(s);
            }
            loadRealtimeData();
        }
    });

    function loadRealtimeData() {
        db.collection("products").onSnapshot(snap => { allProducts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderInventory(); });
        db.collection("suppliers").orderBy("name").onSnapshot(snap => { allSuppliers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderSuppliers(); updateSupplierSelects(); });
        db.collection("missing").orderBy("date", "desc").onSnapshot(snap => { allMissing = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderMissingList(); });
        db.collection("logs").orderBy("date", "desc").limit(100).onSnapshot(snap => { allLogs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderLogs(); });
    }

    // --- LOGLARI RENDER ETME ---
    function renderLogs() {
        const search = document.getElementById('logSearch').value.toLowerCase();
        const typeFilter = document.getElementById('logTypeFilter').value;
        let h = "";

        allLogs.filter(l => {
            const matchSearch = l.detail.toLowerCase().includes(search) || l.action.toLowerCase().includes(search) || l.user.toLowerCase().includes(search);
            const matchType = typeFilter ? l.type === typeFilter : true;
            return matchSearch && matchType;
        }).forEach(l => {
            const userShort = l.user.split('@')[0].toUpperCase();
            h += `
            <div class="log-entry log-type-${l.type || 'varsayilan'}">
                <div class="log-header">
                    <span class="log-user">ğŸ‘¤ ${userShort}</span>
                    <span class="log-date">${l.date}</span>
                </div>
                <div class="log-body">
                    <span class="log-title">${l.action}</span>
                    <pre class="log-detail-box">${l.detail}</pre>
                </div>
            </div>`;
        });
        document.getElementById('logContent').innerHTML = h || "<p style='text-align:center; color:#999;'>Log bulunamadÄ±.</p>";
    }

    // --- GELÄ°ÅMÄ°Å LOG EKLEME (KARÅILAÅTIRMALI) ---
    function addAuditLog(type, action, detail) {
        db.collection("logs").add({
            user: auth.currentUser.email,
            type: type, // yeni, guncelleme, odeme, eksik
            action: action,
            detail: detail,
            date: new Date().toLocaleString('tr-TR'),
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // --- ÃœRÃœN KAYDET VE KARÅILAÅTIR ---
    async function saveProduct() {
        const id = document.getElementById('p_id').value;
        const newP = {
            name: document.getElementById('p_name').value.trim(),
            supplier: document.getElementById('p_supplier_select').value,
            buyPrice: parseFloat(document.getElementById('p_buy').value) || 0,
            sellWholesale: parseFloat(document.getElementById('p_sellW').value) || 0,
            sellRetail: parseFloat(document.getElementById('p_sellR').value) || 0,
            info: document.getElementById('p_info').value.trim()
        };

        if(!newP.name) return;

        if (id) {
            // GÃœNCELLEME: Eskisiyle karÅŸÄ±laÅŸtÄ±r
            const oldP = allProducts.find(x => x.id === id);
            let diff = [];
            if(oldP.name !== newP.name) diff.push(`Ä°sim: ${oldP.name} -> ${newP.name}`);
            if(oldP.supplier !== newP.supplier) diff.push(`ToptancÄ±: ${oldP.supplier} -> ${newP.supplier}`);
            if(oldP.buyPrice !== newP.buyPrice) diff.push(`AlÄ±ÅŸ: ${formatTRY(oldP.buyPrice)} -> ${formatTRY(newP.buyPrice)}`);
            if(oldP.sellWholesale !== newP.sellWholesale) diff.push(`Toptan: ${formatTRY(oldP.sellWholesale)} -> ${formatTRY(newP.sellWholesale)}`);
            if(oldP.sellRetail !== newP.sellRetail) diff.push(`Perakende: ${formatTRY(oldP.sellRetail)} -> ${formatTRY(newP.sellRetail)}`);
            if(oldP.info !== newP.info) diff.push(`Not/Raf: ${oldP.info || 'BoÅŸ'} -> ${newP.info || 'BoÅŸ'}`);

            if(diff.length > 0) {
                await db.collection("products").doc(id).update(newP);
                addAuditLog("guncelleme", `âœï¸ ÃœrÃ¼n GÃ¼ncellendi: ${newP.name}`, diff.join('\n'));
            }
        } else {
            // YENÄ° KAYIT
            await db.collection("products").add(newP);
            const detail = `ÃœrÃ¼n: ${newP.name}\nToptancÄ±: ${newP.supplier}\nAlÄ±ÅŸ: ${formatTRY(newP.buyPrice)}\nToptan: ${formatTRY(newP.sellWholesale)}\nPerakende: ${formatTRY(newP.sellRetail)}\nNot: ${newP.info}`;
            addAuditLog("yeni", `âœ¨ Yeni ÃœrÃ¼n Eklendi`, detail);
        }
        resetProductForm();
        showPage('inventory');
    }

    // --- TOPTANCI BAKÄ°YE VE LOG ---
    async function updateBalance(id, n, t) {
        const v = prompt(n + " iÅŸlem tutarÄ±:");
        if (v && !isNaN(v)) {
            const s = allSuppliers.find(x => x.id === id);
            const tutar = parseFloat(v);
            const nb = (s.balance || 0) + (t === 'borc' ? tutar : -tutar);
            
            await db.collection("suppliers").doc(id).update({ balance: nb });
            
            const detail = `ToptancÄ±: ${n}\nÄ°ÅŸlem: ${t === "borc" ? "BorÃ§ YazÄ±ldÄ± (+)" : "Ã–deme YapÄ±ldÄ± (-)"}\nMiktar: ${formatTRY(tutar)}\nEski Bakiye: ${formatTRY(s.balance)}\nYeni Bakiye: ${formatTRY(nb)}`;
            addAuditLog("odeme", `ğŸ’° Bakiye DeÄŸiÅŸimi`, detail);
        }
    }

    // --- DÄ°ÄER FONKSÄ°YONLAR ---
    function renderInventory() {
        const isAdmin = auth.currentUser?.email === patronEmail;
        let h = "";
        [...allProducts].sort((a,b) => a.name.localeCompare(b.name, 'tr')).forEach(p => {
            h += `<tr>
                <td><b>${p.name}</b><br><small>${p.supplier}</small></td>
                <td class="admin-only" style="color:var(--danger)">${formatTRY(p.buyPrice)}</td>
                <td>${formatTRY(p.sellWholesale)}</td>
                <td>${formatTRY(p.sellRetail)}</td>
                <td>
                    <button class="btn-small" style="background:var(--primary)" onclick="markAsMissing('${p.id}','${p.name}','${p.supplier}')">Eksik</button>
                    ${isAdmin ? `<button class="btn-small" style="background:var(--warning)" onclick="goToEdit('${p.id}')">âœï¸</button>` : ''}
                </td>
            </tr>`;
        });
        document.getElementById('invBody').innerHTML = h;
    }

    function renderSuppliers() {
        const isAdmin = auth.currentUser?.email === patronEmail;
        const f = document.getElementById('supSearch').value.toLowerCase();
        let h = "";
        allSuppliers.filter(s => s.name.toLowerCase().includes(f)).forEach(s => {
            h += `<div class="item-card">
                <div style="font-weight:bold; height:35px;">${s.name}</div>
                <div style="font-size:18px; font-weight:bold; color:${s.balance > 0 ? 'var(--danger)' : 'var(--accent)'}">${formatTRY(s.balance)}</div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button class="btn-small" style="background:var(--danger); flex:1" onclick="updateBalance('${s.id}','${s.name}','borc')">BORÃ‡</button>
                    <button class="btn-small" style="background:var(--accent); flex:1" onclick="updateBalance('${s.id}','${s.name}','odeme')">Ã–DEME</button>
                </div>
            </div>`;
        });
        document.getElementById('supGridBody').innerHTML = h;
    }

    function markAsMissing(id, n, s) {
        const m = prompt("Miktar?");
        if (m) {
            db.collection("missing").add({ name: n, supplier: s, amount: m, status: 'bekliyor', date: new Date().toLocaleString('tr-TR') });
            addAuditLog("eksik", `ğŸ“‹ Eksik YazÄ±ldÄ±`, `ÃœrÃ¼n: ${n}\nMiktar: ${m}\nToptancÄ±: ${s}`);
        }
    }

    function goToEdit(id) {
        const p = allProducts.find(x => x.id === id);
        if(!p) return;
        document.getElementById('p_id').value = id;
        document.getElementById('p_name').value = p.name;
        document.getElementById('p_supplier_select').value = p.supplier;
        document.getElementById('p_buy').value = p.buyPrice;
        document.getElementById('p_sellW').value = p.sellWholesale;
        document.getElementById('p_sellR').value = p.sellRetail;
        document.getElementById('p_info').value = p.info || "";
        document.getElementById('formTitle').innerText = "âœï¸ DÃ¼zenle: " + p.name;
        document.getElementById('editModeInfo').style.display = "block";
        document.getElementById('resetBtn').style.display = "block";
        showPage('add-product');
    }

    function resetProductForm() {
        document.getElementById('p_id').value = "";
        document.getElementById('formTitle').innerText = "âš™ï¸ Yeni ÃœrÃ¼n KaydÄ±";
        document.getElementById('editModeInfo').style.display = "none";
        document.getElementById('resetBtn').style.display = "none";
        document.querySelectorAll('#add-product input').forEach(i => i.value = "");
        document.getElementById('p_supplier_select').value = "";
    }

    function showPage(p) {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active-page'));
        document.getElementById(p).classList.add('active-page');
        document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active-nav'));
        document.getElementById('btn-'+p)?.classList.add('active-nav');
    }

    function updateSupplierSelects() {
        let h = '<option value="">ToptancÄ± SeÃ§...</option>';
        allSuppliers.forEach(s => h += `<option value="${s.name}">${s.name}</option>`);
        document.getElementById('p_supplier_select').innerHTML = h;
        document.getElementById('missingFilter').innerHTML = '<option value="">TÃ¼m ToptancÄ±lar</option>' + h;
    }

    function searchInventory() {
        const f = document.getElementById('mainSearch').value.toLowerCase();
        document.querySelectorAll('#invBody tr').forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(f) ? "" : "none");
    }

    function renderMissingList() {
        const f = document.getElementById('missingFilter').value;
        const isAdmin = auth.currentUser?.email === patronEmail;
        let h = "";
        allMissing.filter(m => m.status === 'bekliyor' && (!f || m.supplier === f)).forEach(m => {
            h += `<tr><td><b>${m.name}</b><br><small>${m.supplier}</small></td><td>${m.amount}</td><td>${isAdmin ? `<button class="btn-small" style="background:var(--accent)" onclick="markAsSupplied('${m.id}','${m.name}')">âœ“</button>` : 'Bekliyor'}</td></tr>`;
        });
        document.getElementById('missingBody').innerHTML = h;
    }

    async function markAsSupplied(id, n) {
        if(confirm("Geldi olarak iÅŸaretlensin mi?")) {
            await db.collection("missing").doc(id).update({ status: 'tamam' });
            addAuditLog("eksik", "âœ… Eksik TamamlandÄ±", `ÃœrÃ¼n: ${n}`);
        }
    }

    function logout() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
