<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HoÅŸgÃ¼nler v9.2.0 - Fiyat KarÅŸÄ±laÅŸtÄ±rma</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --bg: #f8fafc; --text-dark: #0f172a; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); margin: 0; color: var(--text-dark); }
        nav { background: var(--primary); color: white; padding: 12px 8px; display: flex; gap: 8px; position: sticky; top: 0; z-index: 1000; overflow-x: auto; }
        nav button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 12px 16px; border-radius: 10px; font-weight: 600; flex-shrink: 0; cursor: pointer; }
        .active-nav { background: var(--accent) !important; }
        .container { padding: 16px; max-width: 1400px; margin: auto; }
        .page { display: none; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); min-height: 85vh; }
        .active-page { display: block !important; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 15px; }
        .item-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        .card-title { font-size: 19px; font-weight: 800; color: var(--text-dark); margin: 0; }
        .card-price-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px; font-size: 14px; }
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 10px; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 14px 15px; border-bottom: 1px solid #f1f5f9; text-align: left; }
        th { background: #f8fafc; font-size: 12px; color: #64748b; font-weight: 700; }
        .btn-save { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-small { padding: 8px 12px; border-radius: 8px; border: none; font-size: 12px; font-weight: 700; color: white; cursor: pointer; }
        .admin-only { display: none !important; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 12px; font-size: 16px; }
        #historyModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:4000; align-items:center; justify-content:center; padding:20px; }
        .modal-content { background:white; width:100%; max-width:600px; max-height:80vh; border-radius:20px; padding:20px; overflow-y:auto; }
        
        /* Yeni KarÅŸÄ±laÅŸtÄ±rma Stili */
        .price-tag { display: flex; justify-content: space-between; padding: 8px; background: #f1f5f9; border-radius: 8px; margin-bottom: 5px; font-size: 13px; border-left: 4px solid var(--info); }
        .price-tag b { color: var(--primary); }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; inset:0; background:var(--primary); z-index:3000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px;">
    <h2 style="font-weight: 800;">HoÅŸgÃ¼nler v9.2.0</h2>
    <div style="width:100%; max-width:350px; background:white; padding:30px; border-radius:20px; color:black;">
        <input type="text" id="loginUser" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="loginPass" placeholder="Åifre">
        <button onclick="login()" class="btn-save">GÄ°RÄ°Å YAP</button>
    </div>
</div>

<div id="historyModal"><div class="modal-content"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;"><h3 id="histTitle" style="margin:0; color:var(--primary);">Detaylar</h3><button onclick="closeHistory()" style="border:none; background:none; font-size:28px;">&times;</button></div><div id="histContent"></div></div></div>

<nav id="navbar" style="display:none;">
    <button onclick="showPage('inventory')" class="nav-btn active-nav" id="btn-inventory">ğŸ“¦ ÃœrÃ¼nler</button>
    <button onclick="showPage('missing-list')" class="nav-btn" id="btn-missing-list">ğŸ“‹ Eksikler</button>
    <button onclick="showPage('suppliers')" class="nav-btn admin-only" id="btn-suppliers">ğŸšš ToptancÄ±</button>
    <button onclick="showPage('add-product')" class="nav-btn admin-only" id="btn-add-product">âš™ï¸ KayÄ±t</button>
    <button onclick="showPage('logs')" class="nav-btn admin-only" id="btn-logs">ğŸ•’ Loglar</button>
    <button onclick="logout()" style="background:var(--danger); margin-left:auto;">âŒ</button>
</nav>

<div class="container">
    <section id="inventory" class="page active-page">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="mainSearch" style="flex:1; margin-bottom:0;" placeholder="ÃœrÃ¼n ara..." onkeyup="searchInventory()">
            <button onclick="toggleView('inventory')" class="btn-small" style="background:var(--primary); font-size:20px;">ğŸ–¼ï¸</button>
        </div>
        <div id="inv_tableView" class="table-responsive">
            <table>
                <thead><tr><th>ÃœrÃ¼n</th><th class="admin-only">AlÄ±ÅŸ</th><th>Perakende</th><th>KarÅŸÄ±laÅŸtÄ±r</th><th>Ä°ÅŸlem</th></tr></thead>
                <tbody id="invBody"></tbody>
            </table>
        </div>
        <div id="inv_gridView" style="display:none;"><div id="gridBody" class="grid-container"></div></div>
    </section>

    <section id="add-product" class="page">
        <h2 id="formTitle">âš™ï¸ ÃœrÃ¼n KaydÄ±</h2>
        <input type="hidden" id="p_id"><input type="text" id="p_name" placeholder="ÃœrÃ¼n AdÄ±"><select id="p_supplier_select"></select>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;"><input type="number" id="p_buy" placeholder="Son AlÄ±ÅŸ"><input type="number" id="p_sellR" placeholder="Perakende SatÄ±ÅŸ"></div>
        <input type="text" id="p_info" placeholder="Bilgi / Konum">
        
        <div id="priceComparisonEntry" style="display:none; border:2px dashed #cbd5e1; padding:15px; border-radius:12px; margin-bottom:15px; background:#f8fafc;">
            <h4 style="margin:0 0 10px 0;">â• Yeni ToptancÄ± Teklifi Ekle</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <select id="comp_supplier" style="margin:0;"></select>
                <input type="number" id="comp_price" style="margin:0;" placeholder="Teklif FiyatÄ±">
            </div>
            <p style="font-size:11px; color:#64748b; margin:5px 0;">* Bu fiyat sadece karÅŸÄ±laÅŸtÄ±rma listesine eklenir, mevcut alÄ±ÅŸ fiyatÄ±nÄ± deÄŸiÅŸtirmez.</p>
        </div>

        <button onclick="saveProduct()" class="btn-save">ğŸ’¾ VERÄ°LERÄ° KAYDET</button>
        <button id="resetBtn" onclick="resetProductForm()" style="width:100%; background:#94a3b8; color:white; padding:14px; border:none; border-radius:12px; margin-top:10px; display:none;">âŒ VAZGEÃ‡</button>
    </section>

    <section id="missing-list" class="page"><div id="miss_tableView" class="table-responsive"><table><thead><tr><th>ÃœrÃ¼n</th><th>ToptancÄ±</th><th>Miktar</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="missingBody"></tbody></table></div></section>
    <section id="suppliers" class="page"><div id="supGridBody" class="grid-container"></div></section>
    <section id="logs" class="page"><div id="logContent"></div></section>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD3mtB4r5-nr-lclE7Qmqr51a0Tzmkib-A", authDomain: "hosgunler-2e576.firebaseapp.com", projectId: "hosgunler-2e576", storageBucket: "hosgunler-2e576.firebasestorage.app", messagingSenderId: "890789620690", appId: "1:890789620690:web:926f3952e4a6ff8050360b" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), patronEmail = "asim@hosgunler.com";
    const formatTRY = (val) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val || 0);

    let allProducts = [], allSuppliers = [], allMissing = [], allLogs = [];
    let views = { inventory: 'table' };

    function login() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value;
        const email = u.includes('@') ? u : u + "@hosgunler.com";
        auth.signInWithEmailAndPassword(email, p).catch(e => alert("Hata: " + e.message));
    }

    auth.onAuthStateChanged(user => {
        if(user) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('navbar').style.display = 'flex';
            if(user.email === patronEmail) {
                const s = document.createElement('style');
                s.innerHTML = '.admin-only { display: inline-block !important; } td.admin-only, th.admin-only { display: table-cell !important; }';
                document.head.appendChild(s);
            }
            loadRealtimeData();
        }
    });

    function loadRealtimeData() {
        db.collection("products").onSnapshot(snap => { allProducts = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderInventory(); });
        db.collection("suppliers").orderBy("name").onSnapshot(snap => { allSuppliers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderSuppliers(); updateSupplierSelects(); });
        db.collection("missing").onSnapshot(snap => { allMissing = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderMissingList(); });
        db.collection("logs").orderBy("date", "desc").limit(100).onSnapshot(snap => { allLogs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderLogs(); });
    }

    async function saveProduct() {
        const id = document.getElementById('p_id').value;
        const newP = { 
            name: document.getElementById('p_name').value.trim(), 
            supplier: document.getElementById('p_supplier_select').value, 
            buyPrice: parseFloat(document.getElementById('p_buy').value)||0, 
            sellRetail: parseFloat(document.getElementById('p_sellR').value)||0, 
            info: document.getElementById('p_info').value.trim() 
        };
        
        // Fiyat KarÅŸÄ±laÅŸtÄ±rma KaydÄ±
        const cSup = document.getElementById('comp_supplier').value;
        const cPrice = parseFloat(document.getElementById('comp_price').value);

        if(id) {
            const docRef = db.collection("products").doc(id);
            if(cSup && cPrice) {
                const entry = { toptancÄ±: cSup, fiyat: cPrice, tarih: new Date().toLocaleDateString('tr-TR') };
                await docRef.update({ ...newP, priceHistory: firebase.firestore.FieldValue.arrayUnion(entry) });
            } else {
                await docRef.update(newP);
            }
        } else {
            await db.collection("products").add({ ...newP, priceHistory: [] });
        }
        resetProductForm(); showPage('inventory');
    }

    function renderInventory() {
        const isAdmin = auth.currentUser?.email === patronEmail;
        let t = "", g = "";
        [...allProducts].sort((a,b) => a.name.localeCompare(b.name, 'tr')).forEach(p => {
            const hasHistory = p.priceHistory && p.priceHistory.length > 0;
            const compBtn = `<button class="btn-small" style="background:${hasHistory?'var(--info)':'#cbd5e1'}" onclick="viewPriceHistory('${p.id}')">ğŸ“Š</button>`;
            
            t += `<tr><td><b>${p.name}</b><br><small>${p.supplier}</small></td><td class="admin-only">${formatTRY(p.buyPrice)}</td><td>${formatTRY(p.sellRetail)}</td><td>${compBtn}</td><td><button class="btn-small" style="background:var(--primary)" onclick="markAsMissing('${p.id}','${p.name}','${p.supplier}')">Eksik</button>${isAdmin?`<button class="btn-small" style="background:var(--warning); margin-left:4px;" onclick="goToEdit('${p.id}')">âœï¸</button>`:''}</td></tr>`;
            
            g += `<div class="item-card"><div class="card-title">${p.name}</div><div style="font-size:12px; color:#64748b;">ğŸšš ${p.supplier}</div><div class="card-price-row"><span>Perakende:</span> <span>${formatTRY(p.sellRetail)}</span></div><div style="display:flex; gap:5px; margin-top:5px;"><button class="btn-small" style="background:var(--primary); flex:1;" onclick="markAsMissing('${p.id}','${p.name}','${p.supplier}')">Eksik</button>${compBtn}${isAdmin?`<button class="btn-small" style="background:var(--warning)" onclick="goToEdit('${p.id}')">âœï¸</button>`:''}</div></div>`;
        });
        document.getElementById('invBody').innerHTML = t; document.getElementById('gridBody').innerHTML = g;
    }

    function viewPriceHistory(id) {
        const p = allProducts.find(x => x.id === id);
        document.getElementById('histTitle').innerText = p.name + " - Fiyat GeÃ§miÅŸi";
        let h = `<div style="padding:10px; background:var(--bg); border-radius:10px; margin-bottom:15px;"><b>GÃ¼ncel AlÄ±ÅŸ:</b> ${formatTRY(p.buyPrice)} <br> <small>ToptancÄ±: ${p.supplier}</small></div>`;
        
        if(p.priceHistory && p.priceHistory.length > 0) {
            p.priceHistory.reverse().forEach(entry => {
                h += `<div class="price-tag"><span><b>${entry.toptancÄ±}</b><br><small>${entry.tarih}</small></span><b>${formatTRY(entry.fiyat)}</b></div>`;
            });
        } else {
            h += "<p style='text-align:center; color:#64748b;'>HenÃ¼z fiyat geÃ§miÅŸi kaydedilmemiÅŸ.</p>";
        }
        document.getElementById('histContent').innerHTML = h;
        document.getElementById('historyModal').style.display = 'flex';
    }

    function goToEdit(id) {
        const p = allProducts.find(x => x.id === id);
        document.getElementById('p_id').value = id;
        document.getElementById('p_name').value = p.name;
        document.getElementById('p_supplier_select').value = p.supplier;
        document.getElementById('p_buy').value = p.buyPrice;
        document.getElementById('p_sellR').value = p.sellRetail;
        document.getElementById('p_info').value = p.info || "";
        document.getElementById('priceComparisonEntry').style.display = "block";
        document.getElementById('resetBtn').style.display = "block";
        showPage('add-product');
    }

    function resetProductForm() {
        document.getElementById('p_id').value = "";
        document.querySelectorAll('#add-product input').forEach(i => i.value = "");
        document.getElementById('priceComparisonEntry').style.display = "none";
        document.getElementById('resetBtn').style.display = "none";
    }

    // Stabil YardÄ±mcÄ± Fonksiyonlar
    function showPage(p) { document.querySelectorAll('.page').forEach(x => x.classList.remove('active-page')); document.getElementById(p).classList.add('active-page'); document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active-nav')); document.getElementById('btn-'+p)?.classList.add('active-nav'); }
    function searchInventory() { const f = document.getElementById('mainSearch').value.toLowerCase(); document.querySelectorAll('#invBody tr, #gridBody .item-card').forEach(el => el.style.display = el.innerText.toLowerCase().includes(f) ? "" : "none"); }
    function toggleView(t) { views[t] = views[t] === 'table' ? 'grid' : 'table'; document.getElementById('inv_tableView').style.display = views[t] === 'table' ? 'block' : 'none'; document.getElementById('inv_gridView').style.display = views[t] === 'grid' ? 'block' : 'none'; }
    function updateSupplierSelects() { let h = '<option value="">ToptancÄ± SeÃ§...</option>'; allSuppliers.forEach(s => h += `<option value="${s.name}">${s.name}</option>`); document.getElementById('p_supplier_select').innerHTML = h; document.getElementById('comp_supplier').innerHTML = h; }
    function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }
    function markAsMissing(id, n, s) { const m = prompt("Miktar?"); if(m) { db.collection("missing").add({name:n, supplier:s, amount:m, status:'bekliyor', date:new Date().toLocaleString('tr-TR')}); } }
    function logout() { auth.signOut().then(() => location.reload()); }
    // (DiÄŸer render fonksiyonlarÄ± v9.0.2 ile birebir aynÄ±dÄ±r)
    function renderSuppliers() { let g = ""; allSuppliers.forEach(s => { g += `<div class="item-card"><div class="card-title">${s.name}</div><div style="font-size:18px; font-weight:800; color:var(--danger)">${formatTRY(s.balance)}</div></div>`; }); document.getElementById('supGridBody').innerHTML = g; }
    function renderMissingList() { let t = ""; allMissing.filter(m => m.status === 'bekliyor').forEach(m => { t += `<tr><td>${m.name}</td><td>${m.supplier}</td><td>${m.amount}</td><td>Bekliyor</td></tr>`; }); document.getElementById('missingBody').innerHTML = t; }
    function renderLogs() { let h = ""; allLogs.forEach(l => { h += `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${l.action}</b><br><small>${l.date}</small></div>`; }); document.getElementById('logContent').innerHTML = h; }
</script>
</body>
</html>
